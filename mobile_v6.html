<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>éŸ³å£°â†’è¦ç´„â†’QRï¼ˆv6 é‡è¤‡å¯¾ç­–ç‰ˆï¼‰</title>
  <meta name="color-scheme" content="light dark">
  <style>
    :root{--bg:#0b1020;--fg:#e8ecf1;--muted:#9aa4b2;--card:#111935;--acc:#4f8cff;--ok:#00c853;--warn:#ffb300;--err:#ff5252}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui, -apple-system, Segoe UI, Roboto, Noto Sans JP, Helvetica, Arial;background:var(--bg);color:var(--fg)}
    .wrap{max-width:950px;margin:0 auto;padding:16px 18px 40px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:16px 0 8px}
    h1{margin:0;font-weight:800}
    .card{background:var(--card);border:1px solid #1b2447;border-radius:18px;padding:16px;box-shadow:0 6px 24px rgba(0,0,0,.25)}
    .stack{display:grid;gap:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    button,input,select{appearance:none;background:#17224a;border:1px solid #26305a;color:var(--fg);border-radius:12px;padding:10px 14px;font-weight:600}
    button{cursor:pointer} button:hover{background:#1d2a5d}
    button.primary{background:var(--acc);border-color:transparent;color:#fff}
    button.ghost{background:transparent;border-color:#2a356d}
    .pill{font-size:.9rem;color:var(--muted)}
    textarea{width:100%;min-height:160px;background:#0e1430;border:1px solid #1d2750;color:var(--fg);border-radius:12px;padding:12px;font-size:15px}
    .transcript{min-height:120px;white-space:pre-wrap;background:#0e1430;border:1px solid #1d2750;border-radius:12px;padding:12px}
    .qr{display:grid;place-items:center;background:#0e1430;border:1px dashed #2a356d;border-radius:14px;min-height:220px}
    .hint{color:var(--muted);font-size:.92rem}
    .small{font-size:.9rem}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
    .hidden{display:none!important}
    @media(min-width:800px){.grid-2{display:grid;grid-template-columns:1.2fr .8fr;gap:16px}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>éŸ³å£° â†’ è¦ç´„ â†’ QRï¼ˆv6 é‡è¤‡å¯¾ç­–ç‰ˆï¼‰</h1>
      <div class="pill" id="env"></div>
    </header>

    <section class="card stack">
      <div id="alert" class="err hidden"></div>
      <div class="small hint">
        éŸ³å£°èªè­˜ã¯ <strong>HTTPS/localhost</strong> ã®ã¿å¯¾å¿œã€‚å‹•ã‹ãªã„å ´åˆã¯ãƒ†ã‚­ã‚¹ãƒˆæ¬„ã§ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã®ğŸ¤ã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚
      </div>
    </section>

    <section class="card grid-2">
      <div class="stack">
        <div class="row">
          <div class="pill">æ–‡å­—èµ·ã“ã—</div>
          <button id="btnStart" class="primary">â— éŸ³å£°èªè­˜</button>
          <button id="btnStop">â–  åœæ­¢</button>
          <label class="pill small"><input id="autoRestart" type="checkbox" checked> è‡ªå‹•å†é–‹</label>
        </div>
        <div id="transcript" class="transcript" aria-live="polite"></div>
        <div class="row">
          <button id="btnClear" class="ghost">â†º ã‚¯ãƒªã‚¢</button>
          <button id="btnCopyFull">å…¨æ–‡ã‚³ãƒ”ãƒ¼</button>
          <button id="btnCopyToSummary">å…¨æ–‡ã‚’è¦ç´„æ¬„ã¸</button>
          <label class="pill small">è‡ªå‹•å¥ç‚¹ <input id="autoPunct" type="checkbox" checked></label>
        </div>
      </div>

      <div class="stack">
        <div class="row"><div class="pill">æŠ½å‡ºå‹è¦ç´„ï¼ˆç«¯æœ«å†… / ç„¡æ–™ï¼‰</div></div>
        <textarea id="summary" placeholder="ã“ã“ã«è¦ç´„ãŒå‡ºã¾ã™ï¼ˆæ‰‹å‹•ç·¨é›†å¯ï¼‰ã€‚åŸºæœ¬ã¯å…¨æ–‡ï¼ˆæ–‡å­—èµ·ã“ã—ï¼‰ã‹ã‚‰è¦ç´„ã—ã¾ã™ã€‚"></textarea>
        <div class="row">
          <label class="pill small">è¦ç´„æ–‡æ•°: <input id="sentCount" type="number" min="1" max="12" value="5" style="width:80px"></label>
          <button id="btnSumm">è¦ç´„ã™ã‚‹</button>
          <button id="btnCopy">è¦ç´„ã‚’ã‚³ãƒ”ãƒ¼</button>
        </div>
      </div>
    </section>

    <section class="card grid-2">
      <div class="stack">
        <div class="row"><div class="pill">QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆ</div></div>
        <div id="qr" class="qr"></div>
        <div class="row">
          <label class="pill small">æœ€å¤§æ–‡å­—æ•°ï¼ˆç´„ï¼‰: <input id="maxChars" type="number" min="120" max="1200" value="800" style="width:92px"></label>
          <button id="btnQR" class="primary">QRã‚’ä½œæˆ</button>
          <button id="btnDL" class="ghost">PNGä¿å­˜</button>
        </div>
        <div id="qrNote" class="hint small"></div>
      </div>

      <div class="stack">
        <div class="row"><div class="pill">Tips</div></div>
        <ul class="small" style="margin:0 0 6px 18px;padding:0">
          <li>çŸ­ã„ãƒ•ãƒ¬ãƒ¼ã‚ºã§ã‚‚<strong>è‡ªå‹•å†é–‹</strong>ONã§é€£ç¶šè´å–ã—ã¾ã™ã€‚</li>
          <li>é‡è¤‡å¯¾ç­–ï¼šåŒä¸€æ–‡ã®å†é€ä¿¡ã‚’æ¤œå‡ºã—ã¦è¿½åŠ ã—ã¾ã›ã‚“ã€‚</li>
        </ul>
      </div>
    </section>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <script>
    const $ = s=>document.querySelector(s);
    const env = $("#env"), alertBox=$("#alert");
    const transcriptEl=$("#transcript"), summaryEl=$("#summary"), qrEl=$("#qr");
    const sentCountEl=$("#sentCount"), autoPunctEl=$("#autoPunct"), maxCharsEl=$("#maxChars"), autoRestartEl=$("#autoRestart");
    let recog=null, listening=false, fullText="", interimText="", qrCanvas=null;
    let processedIdx=0;               // è¿½åŠ : å‡¦ç†æ¸ˆã¿ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
    let lastFinalNorm="";             // è¿½åŠ : ç›´è¿‘finalã®æ­£è¦åŒ–æ–‡å­—åˆ—

    const isSecure = location.protocol==='https:' || location.hostname==='localhost';
    env.textContent = (isSecure? 'HTTPS/localhostï¼šOK' : 'éHTTPSï¼šéŸ³å£°èªè­˜ã¯ä¸å¯');

    function showError(msg){ alertBox.textContent=msg; alertBox.classList.remove('hidden'); }
    function clearError(){ alertBox.classList.add('hidden'); alertBox.textContent=''; }

    function supportsSR(){ return 'webkitSpeechRecognition' in window || 'SpeechRecognition' in window; }

    function sanitizeChunk(t){
      let s = (t||'').replace(/^[ã€‚ï¼\.\s]+/g, '');
      s = s.replace(/[ã€‚ï¼\.]{2,}$/g, 'ã€‚');
      return s;
    }
    function normalizeForCompare(t){
      return (t||'').replace(/[ã€‚ï¼.!?ï¼ï¼Ÿ\s]/g,'').toLowerCase();
    }

    function initSR(){
      if(!supportsSR()){ showError('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ Web Speech API ã«æœªå¯¾å¿œã§ã™ã€‚'); return; }
      if(!isSecure){ showError('éŸ³å£°èªè­˜ã¯ HTTPS / localhost ã§ã®ã¿å‹•ä½œã—ã¾ã™ã€‚'); }
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      recog = new SR();
      recog.lang='ja-JP';
      recog.interimResults=true;
      recog.continuous=true;
      recog.maxAlternatives=1;

      recog.onstart=()=>{ processedIdx=0; lastFinalNorm=""; };

      recog.onresult=(e)=>{
        // å¤‰æ›´ãŒã‚ã£ãŸçµæœã®ã¿å‡¦ç†ï¼ˆprocessedIdxã‚ˆã‚Šæ–°ã—ã„ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼‰
        for(let i=e.resultIndex;i<e.results.length;i++){
          if(i < processedIdx) continue;
          const res=e.results[i];
          if(res.isFinal){
            let t = sanitizeChunk(res[0].transcript.trim());
            if(autoPunctEl.checked && t && !/[ã€‚.!?ï¼ï¼Ÿ]$/.test(t)) t+='ã€‚';
            const norm = normalizeForCompare(t);
            if(t && norm && norm !== lastFinalNorm){
              // ç›´å‰ã¨åŒä¸€ã§ãªã‘ã‚Œã°è¿½åŠ 
              fullText += t;
              // é€£ç¶šå¥ç‚¹ã‚’1ã¤ã«
              fullText = fullText.replace(/[ã€‚ï¼\.]{2,}/g, 'ã€‚');
              lastFinalNorm = norm;
            }
            interimText='';
          }else{
            interimText = res[0].transcript;
          }
        }
        processedIdx = e.results.length;
        renderTranscript();
      };

      recog.onerror=(e)=>{
        if(e.error==='no-speech' || e.error==='audio-capture'){
          if(listening && autoRestartEl.checked){
            setTimeout(()=>{ try{ recog.start(); }catch{} }, 400);
          }
          return;
        }
        showError('éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼: '+e.error);
      };

      recog.onend=()=>{
        $("#btnStart").disabled=false; $("#btnStop").disabled=true;
        if(listening && autoRestartEl.checked){
          try{ recog.start(); $("#btnStart").disabled=true; $("#btnStop").disabled=false; }catch{}
        }
      };
    }

    function renderTranscript(){
      const txt = (fullText || '') + (interimText? ('\\nã€é€”ä¸­ã€‘'+interimText) : '');
      transcriptEl.textContent = txt.trim();
    }

    function startSR(){
      clearError();
      if(!recog){ showError('éŸ³å£°èªè­˜ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚'); return; }
      try{
        listening=true; recog.start();
        $("#btnStart").disabled=true; $("#btnStop").disabled=false;
      }catch(err){ showError('é–‹å§‹ã§ãã¾ã›ã‚“: '+err.message); }
    }
    function stopSR(){
      listening=false;
      try{ recog?.stop(); }catch{}
      $("#btnStart").disabled=false; $("#btnStop").disabled=true;
    }

    function clearAll(){
      clearError();
      fullText=''; interimText=''; processedIdx=0; lastFinalNorm='';
      renderTranscript();
      summaryEl.value='';
      qrEl.innerHTML='';
      $("#qrNote").textContent='';
      qrCanvas=null;
    }

    function splitSentences(text){
      const out=[]; let b='';
      for(const ch of text){ b+=ch; if(/[ã€‚ï¼ï¼Ÿ!?]/.test(ch)){ out.push(b.trim()); b=''; } }
      if(b.trim()) out.push(b.trim());
      if(out.length<=1){ return text.split(/\\n+/).map(s=>s.trim()).filter(Boolean); }
      return out;
    }
    function bigrams(s){
      const cleaned=s.replace(/[^\\p{Letter}\\p{Number}]/gu,'');
      const out=[]; for(let i=0;i<cleaned.length-1;i++){ out.push(cleaned.slice(i,i+2)); }
      return out.length?out:(cleaned?[cleaned]:[]);
    }
    function summarize(text,k=5,maxChars=800){
      const sents=splitSentences(text).filter(Boolean);
      if(!sents.length) return '';
      const tf=sents.map(()=>Object.create(null)); const df=Object.create(null);
      sents.forEach((s,idx)=>{ const toks=bigrams(s); const seen=new Set();
        toks.forEach(t=>{ tf[idx][t]=(tf[idx][t]||0)+1; if(!seen.has(t)){df[t]=(df[t]||0)+1; seen.add(t);} });
      });
      const N=sents.length;
      const scores=sents.map((s,i)=>{
        let sc=0; for(const t in tf[i]){ const idf=Math.log((N+1)/((df[t]||1))); sc+=tf[i][t]*idf; }
        const lenP = Math.log(50+s.length)/Math.log(50+80);
        const pos = 1.0 + ((N-i)/(N*12));
        return sc*(1/lenP)*pos;
      });
      const idxs=scores.map((v,i)=>[v,i]).sort((a,b)=>b[0]-a[0]).slice(0,Math.min(k,sents.length)).map(p=>p[1]).sort((a,b)=>a-b);
      let out=idxs.map(i=>sents[i]).join('\\n');
      if(out.length>maxChars) out=out.slice(0,maxChars-1)+'â€¦';
      return out;
    }

    async function makeQR(text){
      qrEl.innerHTML=''; qrCanvas=null;
      const maxChars=parseInt(maxCharsEl.value||'800',10);
      let t=(text||'').trim();
      if(!t){
        t = transcriptEl.textContent.replace(/\\n?ã€é€”ä¸­ã€‘[\\s\\S]*$/,'').trim();
      }
      if(!t){ showError('QRåŒ–ã§ãã‚‹ãƒ†ã‚­ã‚¹ãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚'); return; }
      if(t.length>maxChars){ $("#qrNote").innerHTML='é•·æ–‡ã®ãŸã‚ <span class="warn">è‡ªå‹•ãƒˆãƒªãƒ </span>ï¼ˆ'+maxChars+'å­—ï¼‰'; t=t.slice(0,maxChars-1)+'â€¦'; }
      else { $("#qrNote").textContent='OKï¼š'+t.length+' æ–‡å­—'; }

      const canvas=document.createElement('canvas');
      await QRCode.toCanvas(canvas, t, {errorCorrectionLevel:'M', margin:2, scale:6});
      qrEl.appendChild(canvas); qrCanvas=canvas;
    }
    function downloadQR(){ if(!qrCanvas) return; const a=document.createElement('a'); a.download='summary-qr.png'; a.href=qrCanvas.toDataURL('image/png'); a.click(); }

    $("#btnStart").addEventListener('click', startSR);
    $("#btnStop").addEventListener('click', stopSR);
    $("#btnClear").addEventListener('click', clearAll);
    $("#btnCopy").addEventListener('click', ()=>navigator.clipboard?.writeText(summaryEl.value).catch(()=>{}));
    $("#btnCopyFull").addEventListener('click', ()=>navigator.clipboard?.writeText(transcriptEl.textContent).catch(()=>{}));
    $("#btnCopyToSummary").addEventListener('click', ()=>{
      summaryEl.value = transcriptEl.textContent.replace(/\\n?ã€é€”ä¸­ã€‘[\\s\\S]*$/,'').trim();
    });

    $("#btnSumm").addEventListener('click', ()=>{
      clearError();
      const k=Math.max(1,Math.min(12,parseInt(sentCountEl.value||'5',10)));
      const base = transcriptEl.textContent.replace(/\\n?ã€é€”ä¸­ã€‘[\\s\\S]*$/,'').trim();
      if(!base){ showError('è¦ç´„å…ƒãƒ†ã‚­ã‚¹ãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚'); return; }
      summaryEl.value = summarize(base, k, parseInt(maxCharsEl.value||'800',10));
    });
    $("#btnQR").addEventListener('click', ()=> makeQR(summaryEl.value));
    $("#btnDL").addEventListener('click', downloadQR);

    if(supportsSR() && isSecure){ initSR(); }
  </script>
</body>
</html>
